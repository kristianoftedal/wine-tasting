---
phase: 01-data-analysis
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/analyze-wine-vocabulary.ts
  - wine-vocabulary-analysis.json
autonomous: true

must_haves:
  truths:
    - "Missing terms in lemma dictionary are identified"
    - "Typos in existing lemmas are documented with corrections"
    - "Results include actionable lists for Phase 2"
  artifacts:
    - path: "wine-vocabulary-analysis.json"
      provides: "Complete analysis with missing terms and typos"
      contains: "missingTerms"
    - path: "wine-vocabulary-analysis.json"
      provides: "Typo suggestions"
      contains: "typoSuggestions"
  key_links:
    - from: "scripts/analyze-wine-vocabulary.ts"
      to: "norwegianLemmas"
      via: "lemma dictionary check"
      pattern: "norwegianLemmas\\[|Object\\.keys\\(norwegianLemmas\\)"
---

<objective>
Identify missing terms and typos in the lemma dictionary by comparing against actual database vocabulary.

Purpose: Generate actionable lists of terms to add and typos to fix in Phase 2 (Category Restructuring). This ensures the lemma dictionary reflects real usage.
Output: Extended JSON with missingTerms and typoSuggestions arrays.
</objective>

<execution_context>
@/Users/kristianoftedal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kristianoftedal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-analysis/01-01-SUMMARY.md
@src/lib/lemmatizeAndWeight.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing terms detection</name>
  <files>scripts/analyze-wine-vocabulary.ts</files>
  <action>
1. Import norwegianLemmas from '../src/lib/lemmatizeAndWeight'
   - Note: norwegianLemmas is not exported. Either:
     a) Export it from lemmatizeAndWeight.ts (add `export` keyword), OR
     b) Create a copy of the lemma keys in the script for comparison
   - Prefer (a) - add `export` to the const declaration in lemmatizeAndWeight.ts

2. Create findMissingTerms function:
   ```typescript
   function findMissingTerms(
     allFrequencies: Map<string, number>,
     existingLemmas: Record<string, unknown>,
     minFrequency: number = 3
   ): { term: string; count: number }[] {
     const missing: { term: string; count: number }[] = [];

     allFrequencies.forEach((count, term) => {
       // Term not in lemmas and appears frequently
       if (!existingLemmas[term] && count >= minFrequency) {
         missing.push({ term, count });
       }
     });

     return missing.sort((a, b) => b.count - a.count);
   }
   ```

3. Update main() to:
   - Combine smell and taste frequencies into allTerms Map
   - Call findMissingTerms(allTerms, norwegianLemmas, 3)
   - Add missingTerms to results object

4. Update AnalysisResults interface:
   ```typescript
   missingTerms: { term: string; count: number }[];
   ```

WHY minFrequency=3: Research suggests terms appearing 3+ times are potentially significant. Lower threshold catches rare but valid terms; higher threshold filters noise. We can adjust based on actual data distribution.
  </action>
  <verify>
Run `npm run analyze` and confirm:
- Script runs without import errors
- Console shows count of missing terms found
- wine-vocabulary-analysis.json contains missingTerms array
  </verify>
  <done>
missingTerms array in JSON contains terms not in norwegianLemmas that appear 3+ times in database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add typo detection</name>
  <files>scripts/analyze-wine-vocabulary.ts</files>
  <action>
1. Create levenshtein distance helper (simple implementation):
   ```typescript
   function levenshteinDistance(a: string, b: string): number {
     if (a.length === 0) return b.length;
     if (b.length === 0) return a.length;

     const matrix: number[][] = [];

     for (let i = 0; i <= b.length; i++) {
       matrix[i] = [i];
     }
     for (let j = 0; j <= a.length; j++) {
       matrix[0][j] = j;
     }

     for (let i = 1; i <= b.length; i++) {
       for (let j = 1; j <= a.length; j++) {
         if (b.charAt(i - 1) === a.charAt(j - 1)) {
           matrix[i][j] = matrix[i - 1][j - 1];
         } else {
           matrix[i][j] = Math.min(
             matrix[i - 1][j - 1] + 1,
             matrix[i][j - 1] + 1,
             matrix[i - 1][j] + 1
           );
         }
       }
     }

     return matrix[b.length][a.length];
   }
   ```

2. Create findTypoSuggestions function:
   ```typescript
   function findTypoSuggestions(
     allFrequencies: Map<string, number>,
     existingLemmas: Record<string, unknown>,
     maxDistance: number = 1
   ): { word: string; suggestion: string; count: number; distance: number }[] {
     const typos: { word: string; suggestion: string; count: number; distance: number }[] = [];
     const lemmaKeys = Object.keys(existingLemmas);

     allFrequencies.forEach((count, word) => {
       // Only check words NOT in lemmas
       if (existingLemmas[word]) return;

       // Check against all lemma keys
       for (const lemma of lemmaKeys) {
         const distance = levenshteinDistance(word, lemma);
         // Only consider close matches (1 edit away)
         if (distance > 0 && distance <= maxDistance && word.length > 3) {
           typos.push({ word, suggestion: lemma, count, distance });
           break; // Only first match per word
         }
       }
     });

     return typos.sort((a, b) => b.count - a.count);
   }
   ```

3. Update main() to:
   - Call findTypoSuggestions(allTerms, norwegianLemmas, 1)
   - Add typoSuggestions to results object

4. Update AnalysisResults interface:
   ```typescript
   typoSuggestions: { word: string; suggestion: string; count: number; distance: number }[];
   ```

5. Add console output for typos found:
   - Print count of potential typos
   - Print top 5 typos with suggestions

WHY maxDistance=1: One edit distance catches common typos (missing letter, extra letter, wrong letter). Distance 2+ produces too many false positives. Words must be > 3 chars to avoid matching common short words.
  </action>
  <verify>
Run `npm run analyze` and confirm:
- Script completes without errors
- Console shows count of potential typos
- wine-vocabulary-analysis.json contains typoSuggestions array
- Typos are plausible (e.g., "solbaer" -> "solbær", "kirsebaer" -> "kirsebær")
  </verify>
  <done>
typoSuggestions array contains words with edit distance 1 from existing lemmas, sorted by frequency.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate actionable summary report</name>
  <files>scripts/analyze-wine-vocabulary.ts</files>
  <action>
1. Add summary statistics to AnalysisResults:
   ```typescript
   summary: {
     totalWines: number;
     uniqueSmellTerms: number;
     uniqueTasteTerms: number;
     termsInLemmas: number;
     termsNotInLemmas: number;
     potentialTypos: number;
     coveragePercent: number;
   }
   ```

2. Calculate coverage statistics:
   - Count terms that ARE in norwegianLemmas
   - Count terms that are NOT in norwegianLemmas
   - Calculate coverage: (termsInLemmas / totalUniqueTerms) * 100

3. Add recommendations section to console output:
   ```
   === ANALYSIS SUMMARY ===
   Total wines analyzed: X
   Unique smell terms: X
   Unique taste terms: X

   === LEMMA COVERAGE ===
   Terms in dictionary: X (X%)
   Terms missing: X
   Potential typos: X

   === TOP 10 MISSING TERMS (add to lemmas) ===
   1. [term]: X occurrences
   ...

   === TOP 5 LIKELY TYPOS (fix in lemmas) ===
   1. "[typo]" -> "[suggestion]" (X occurrences)
   ...

   Full results saved to wine-vocabulary-analysis.json
   ```

4. Ensure JSON file has all fields for Phase 2 consumption:
   - smellTermFrequency
   - tasteTermFrequency
   - colorTermFrequency
   - missingTerms
   - typoSuggestions
   - summary
   - analyzedAt (ISO timestamp)
  </action>
  <verify>
Run `npm run analyze` and confirm:
- Console shows formatted summary report
- Coverage percentage is calculated and displayed
- wine-vocabulary-analysis.json has all expected fields
- File is valid JSON (parseable)
  </verify>
  <done>
Complete analysis with summary statistics. Console shows actionable report. JSON file ready for Phase 2 consumption.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run analyze` produces complete output without errors
2. wine-vocabulary-analysis.json contains:
   - smellTermFrequency, tasteTermFrequency, colorTermFrequency (sorted)
   - missingTerms (terms appearing 3+ times not in lemmas)
   - typoSuggestions (words with edit distance 1 from lemmas)
   - summary with coverage statistics
3. Console output shows actionable summary for human review
4. Coverage percent is reasonable (expect 60-80% for wine domain)
</verification>

<success_criteria>
- Missing terms identified and listed with frequency counts
- Typo suggestions generated using Levenshtein distance
- Summary statistics show lemma coverage percentage
- Console output provides actionable recommendations
- JSON file complete and ready for Phase 2
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-analysis/01-02-SUMMARY.md`
</output>
