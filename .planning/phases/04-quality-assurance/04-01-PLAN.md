---
phase: 04-quality-assurance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.mts
  - package.json
  - src/lib/lemmatizeAndWeight.test.ts
  - src/lib/profiles/config.test.ts
autonomous: true

must_haves:
  truths:
    - "npm test runs without errors"
    - "lemmatizeAndWeight correctly identifies Norwegian wine terms"
    - "Profile switching works via environment variable"
    - "Invalid profile falls back to inverted with warning"
  artifacts:
    - path: "vitest.config.mts"
      provides: "Test runner configuration"
      contains: "vitest/config"
    - path: "src/lib/lemmatizeAndWeight.test.ts"
      provides: "Core lemmatization tests"
      min_lines: 30
    - path: "src/lib/profiles/config.test.ts"
      provides: "Profile selection tests"
      min_lines: 25
  key_links:
    - from: "vitest.config.mts"
      to: "src/**/*.test.ts"
      via: "include pattern"
      pattern: "src/\\*\\*/*.test.ts"
    - from: "package.json"
      to: "vitest"
      via: "test script"
      pattern: "\"test\": \"vitest\""
---

<objective>
Set up Vitest testing infrastructure and write unit tests for core scoring functions.

Purpose: Enable automated verification that lemmatization and profile selection work correctly across different configurations.

Output: Working test suite with vitest config, package.json scripts, and unit tests for lemmatizeAndWeight and profile config.
</objective>

<execution_context>
@/Users/kristianoftedal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kristianoftedal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quality-assurance/04-RESEARCH.md

@src/lib/lemmatizeAndWeight.ts
@src/lib/profiles/config.ts
@src/lib/profiles/weights.ts
@src/lib/profiles/types.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Vitest infrastructure</name>
  <files>
    vitest.config.mts
    package.json
  </files>
  <action>
    1. Install Vitest dev dependencies:
       `npm install -D vitest @vitejs/plugin-react vite-tsconfig-paths`

    2. Create vitest.config.mts at project root:
       - Use defineConfig from vitest/config
       - Add tsconfigPaths() plugin for @/ import alias support
       - Set test.environment to 'node' (pure function tests, no DOM needed)
       - Set test.include to ['src/**/*.test.ts']
       - Optionally add coverage config for src/lib/**/*.ts

    3. Add test scripts to package.json:
       - "test": "vitest"
       - "test:run": "vitest run"

    DO NOT add react plugin (not testing components).
    DO NOT set jsdom environment (testing pure functions).
  </action>
  <verify>
    Run `npm test -- --run` (with empty test suite, should exit 0 or show "no tests found")
  </verify>
  <done>
    Vitest configured with path alias support, test scripts in package.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Write lemmatizeAndWeight unit tests</name>
  <files>
    src/lib/lemmatizeAndWeight.test.ts
  </files>
  <action>
    Create co-located test file src/lib/lemmatizeAndWeight.test.ts testing:

    1. Basic lemmatization:
       - 'solbaer og kirsebær' should lemmatize to ['solbær', 'kirsebær']
       - Stopwords ('og', 'i', 'med') should be filtered out
       - Unknown words should be kept with 'ukjent' category

    2. Weight application:
       - Berry terms (solbær, kirsebær) should get Frukt category weight from active profile
       - Generic terms (frisk, balansert) should get GENERIC category weight
       - Unknown terms should get GENERIC weight

    3. Category assignment:
       - 'eik' should have 'eik' category and Eik/fat categoryPath.main
       - 'balansert' should have 'struktur' category and GENERIC categoryPath.main

    4. TextAnalysis structure:
       - Result has lemmatized array, categories record, weightSum number
       - weightSum equals sum of all individual weights

    5. analyze function:
       - Returns AnalysisResult with data1, data2, similarity, commonLemmas
       - Empty text returns undefined (with alert)
       - Common lemmas are sorted by combined weight

    Import from vitest: describe, it, expect
    Use real norwegianLemmas data (not mocks) to catch actual regressions.
  </action>
  <verify>
    Run `npm test -- --run src/lib/lemmatizeAndWeight.test.ts`
    All tests pass.
  </verify>
  <done>
    lemmatizeAndWeight tests cover lemmatization, weights, categories, analyze function
  </done>
</task>

<task type="auto">
  <name>Task 3: Write profile config unit tests</name>
  <files>
    src/lib/profiles/config.test.ts
  </files>
  <action>
    Create co-located test file src/lib/profiles/config.test.ts testing:

    1. Default profile selection:
       - When NEXT_PUBLIC_WEIGHT_PROFILE is undefined, returns inverted profile
       - Default profile has name 'inverted'

    2. Valid profile selection:
       - 'inverted' returns INVERTED_PROFILE
       - 'moderate' returns MODERATE_PROFILE
       - 'data-driven' returns DATA_DRIVEN_PROFILE

    3. Invalid profile fallback:
       - Invalid profile name (e.g., 'nonexistent') falls back to inverted
       - Console.warn is called with appropriate message

    4. getCategoryWeight function:
       - Returns correct weight for 'Frukt' from active profile
       - Returns correct weight for 'GENERIC' from active profile
       - Different profiles return different weights for same category

    Use vi.stubEnv() and vi.resetModules() pattern for environment variable testing.
    Use vi.unstubAllEnvs() in afterEach for cleanup.
    Use dynamic import() after resetModules to get fresh module state.

    Example pattern:
    ```typescript
    import { describe, it, expect, vi, afterEach } from 'vitest'

    describe('getActiveProfile', () => {
      afterEach(() => {
        vi.unstubAllEnvs()
        vi.resetModules()
      })

      it('should return inverted profile by default', async () => {
        const { getActiveProfile } = await import('./config')
        expect(getActiveProfile().name).toBe('inverted')
      })

      it('should return moderate when configured', async () => {
        vi.stubEnv('NEXT_PUBLIC_WEIGHT_PROFILE', 'moderate')
        vi.resetModules()
        const { getActiveProfile } = await import('./config')
        expect(getActiveProfile().name).toBe('moderate')
      })
    })
    ```
  </action>
  <verify>
    Run `npm test -- --run src/lib/profiles/config.test.ts`
    All tests pass.
  </verify>
  <done>
    Profile tests cover default selection, valid profiles, invalid fallback, getCategoryWeight
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm test -- --run` runs all tests and passes
2. `npm run build` still compiles successfully (TypeScript compatibility maintained)
3. Test files are co-located with source files
</verification>

<success_criteria>
- Vitest infrastructure set up with path alias support
- lemmatizeAndWeight.test.ts covers core scoring behavior
- config.test.ts covers profile selection and fallback
- All tests pass on `npm test -- --run`
- TypeScript compilation still works (no breaking changes)
</success_criteria>

<output>
After completion, create `.planning/phases/04-quality-assurance/04-01-SUMMARY.md`
</output>
