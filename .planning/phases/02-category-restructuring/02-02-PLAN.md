---
phase: 02-category-restructuring
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/lemmatizeAndWeight.ts
autonomous: true

must_haves:
  truths:
    - "WineCategory type uses new CategoryPath structure"
    - "norwegianLemmas entries use hierarchical categories"
    - "Generic structure terms have weight 0.8 (down from 2.0-2.5)"
    - "Specific descriptors maintain weight 1.3-1.8"
    - "Berry categories merged (mørke bær + røde bær -> Frukt/baer)"
    - "Typos from Phase 1 fixed (krydret variants)"
    - "TypeScript compiles without errors"
  artifacts:
    - path: "src/lib/lemmatizeAndWeight.ts"
      provides: "Migrated lemma dictionary with hierarchical categories"
      exports: ["WineCategory", "LemmaData", "norwegianLemmas", "lemmatizeAndWeight"]
      contains: "CategoryPath"
  key_links:
    - from: "src/lib/lemmatizeAndWeight.ts"
      to: "src/lib/categories"
      via: "type imports"
      pattern: "import.*from.*categories"
---

<objective>
Migrate lemmatizeAndWeight.ts to use new hierarchical category structure

Purpose: Complete the category restructuring by migrating the core lemmatization module to use the validated new category structure. This implements the weight inversion (generic 0.8, specific 1.3+) and berry merge per user requirements.

Output: Updated lemmatizeAndWeight.ts using CategoryPath hierarchy with inverted weights
</objective>

<execution_context>
@/Users/kristianoftedal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kristianoftedal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-category-restructuring/02-CONTEXT.md
@.planning/phases/02-category-restructuring/02-RESEARCH.md
@.planning/phases/02-category-restructuring/02-01-SUMMARY.md
@src/lib/categories/index.ts
@src/lib/categories/types.ts
@src/lib/categories/hierarchy.ts
@src/lib/lemmatizeAndWeight.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate WineCategory type and LemmaData to use CategoryPath</name>
  <files>src/lib/lemmatizeAndWeight.ts</files>
  <action>
Update the type definitions at the top of lemmatizeAndWeight.ts:

1. **Import from categories module:**
```typescript
import { CategoryPath, MainCategory, WineSubcategory, LemmaDataV2 } from './categories';
```

2. **Keep backwards-compatible WineCategory type** (for now - can deprecate later):
The old flat WineCategory type is still used by the lemmatizeAndWeight function return types. Keep it but mark as deprecated:
```typescript
/** @deprecated Use CategoryPath instead */
export type WineCategory =
  | 'struktur' | 'kvalitet' | 'ettersmak' | 'fylde' | 'friskhet' | 'sødme'
  | 'bær' | 'sitrus' | 'steinfrukt' | 'frukt' | 'moden-frukt'
  | 'krydder' | 'eik' | 'mineral' | 'blomst' | 'urt'
  | 'annet' | 'tekstur' | 'generell' | 'ukjent';
```

Note: Remove 'mørke bær' and 'røde bær' - they are now merged into 'bær'.

3. **Update LemmaData to use CategoryPath internally but maintain compat:**
```typescript
export type LemmaData = {
  lemma: string;
  weight: number;
  category: WineCategory;  // Keep for backwards compat
  categoryPath?: CategoryPath;  // New hierarchical path
};
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/lib/lemmatizeAndWeight.ts
```
No TypeScript errors.
  </verify>
  <done>
Type definitions updated:
- CategoryPath imported from categories module
- WineCategory marked deprecated, 'mørke bær'/'røde bær' removed
- LemmaData extended with optional categoryPath field
  </done>
</task>

<task type="auto">
  <name>Task 2: Update norwegianLemmas with inverted weights and merged categories</name>
  <files>src/lib/lemmatizeAndWeight.ts</files>
  <action>
Update the norwegianLemmas object with these changes:

**1. STRUKTUR/KVALITET section - LOWER weights from 2.5 to 0.8:**
```typescript
// GENERIC STRUCTURE (low weight - 0.8x) - Per user decision: generic = low
balansert: { lemma: 'balanse', weight: 0.8, category: 'struktur', categoryPath: { main: 'GENERIC', sub: 'structure' } },
// ... all struktur/kvalitet terms get weight: 0.8
```

**2. AVSLUTNING/ETTERSMAK section - LOWER from 2.3 to 0.8:**
```typescript
ettersmak: { lemma: 'ettersmak', weight: 0.8, category: 'ettersmak', categoryPath: { main: 'GENERIC', sub: 'finish' } },
// ... all ettersmak terms get weight: 0.8
```

**3. FYLDE section - LOWER from 2.0 to 0.8:**
```typescript
fylde: { lemma: 'fylde', weight: 0.8, category: 'fylde', categoryPath: { main: 'GENERIC', sub: 'body' } },
```

**4. FRISKHET section - LOWER from 2.0 to 0.8:**
```typescript
friskhet: { lemma: 'frisk', weight: 0.8, category: 'friskhet', categoryPath: { main: 'GENERIC', sub: 'acidity' } },
```

**5. SØDME section - LOWER from 1.8 to 0.8:**
```typescript
sødme: { lemma: 'søt', weight: 0.8, category: 'sødme', categoryPath: { main: 'GENERIC', sub: 'sweetness' } },
```

**6. MERGE MØRKE BÆR + RØDE BÆR into single BÆR category with weight 1.6:**
```typescript
// BÆR (merged category - 1.6x average of old 1.7 and 1.5)
solbær: { lemma: 'solbær', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
bjørnebær: { lemma: 'bjørnebær', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
blåbær: { lemma: 'blåbær', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
moreller: { lemma: 'morell', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
morell: { lemma: 'morell', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
kirsebær: { lemma: 'kirsebær', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
jordbær: { lemma: 'jordbær', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
bringebær: { lemma: 'bringebær', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
rips: { lemma: 'rips', weight: 1.6, category: 'bær', categoryPath: { main: 'Frukt', sub: 'baer' } },
```

**7. Add categoryPath to remaining entries (keep existing weights):**
- sitrus entries: `categoryPath: { main: 'Frukt', sub: 'sitrus' }`
- steinfrukt entries: `categoryPath: { main: 'Frukt', sub: 'steinfrukt' }`
- frukt entries (eple, pære, tropisk, etc.): `categoryPath: { main: 'Frukt', sub: 'annet' }` or appropriate sub
- moden-frukt entries: `categoryPath: { main: 'Frukt', sub: 'toerket' }`
- krydder entries: `categoryPath: { main: 'Krydder', sub: 'annet' }` or 'soet'/'varm'
- eik entries: `categoryPath: { main: 'Eik/fat', sub: 'fatlagring' }` or 'ristet'
- mineral entries: `categoryPath: { main: 'Mineral', sub: 'stein' }`
- blomst entries: `categoryPath: { main: 'Blomster', sub: 'annet' }`
- urt entries: `categoryPath: { main: 'Urter', sub: 'groenn' }`
- annet entries: `categoryPath: { main: 'Eik/fat', sub: 'annet' }` (for kaffe, sjokolade, etc.)
- tekstur entries: `categoryPath: { main: 'GENERIC', sub: 'texture' }`, weight: 0.8
- generell entries: `categoryPath: { main: 'GENERIC', sub: 'general' }`, weight: 0.8

**8. Fix typos from Phase 1:**
Keep `krydrete` pointing to `krydder` lemma (this is correct, not a typo - it's a valid inflection).
No actual typo fixes needed in this file based on Phase 1 analysis - the typos were in the database, not the dictionary.

**Weight summary after changes:**
- Generic terms (struktur, kvalitet, ettersmak, fylde, friskhet, sødme, tekstur, generell): 0.8
- Specific descriptors:
  - Bær (merged): 1.6
  - Sitrus, steinfrukt, mineral: 1.5
  - Frukt (other): 1.4
  - Moden-frukt/tørket: 1.6
  - Krydder: 1.7
  - Eik/fat: 1.8
  - Blomst, urt: 1.3
  - Annet (nøtter, kaffe, etc.): 1.4
  </action>
  <verify>
1. TypeScript compilation:
```bash
npx tsc --noEmit src/lib/lemmatizeAndWeight.ts
```

2. Verify weight inversion worked:
```bash
npx tsx -e "
import { norwegianLemmas } from './src/lib/lemmatizeAndWeight';
const struktur = norwegianLemmas['struktur'];
const solbaer = norwegianLemmas['solbær'];
console.log('struktur weight:', struktur?.weight);
console.log('solbær weight:', solbaer?.weight);
console.log('Weight inverted:', struktur?.weight < solbaer?.weight ? 'YES' : 'NO');
"
```
Expected: struktur weight: 0.8, solbær weight: 1.6, Weight inverted: YES

3. Run validation script to ensure consistency:
```bash
npx tsx scripts/validate-categories.ts
```
  </verify>
  <done>
norwegianLemmas updated with:
- Generic structure terms weight 0.8 (down from 2.0-2.5)
- Berry terms merged into single 'bær' category with weight 1.6
- All entries have categoryPath for hierarchical lookups
- TypeScript compiles without errors
- Weight inversion verified (generic 0.8 < specific 1.3+)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit src/lib/lemmatizeAndWeight.ts` succeeds
2. `npx tsx scripts/validate-categories.ts` passes
3. Weight inversion verified: struktur (0.8) < solbær (1.6)
4. No 'mørke bær' or 'røde bær' categories remain
5. All entries have categoryPath field
</verification>

<success_criteria>
- TypeScript compiles without errors
- Generic structure terms have weight 0.8
- Specific descriptors have weight 1.3-1.8
- Berry categories merged (solbær, kirsebær, etc. all in 'bær')
- All entries have categoryPath field
- Validation script still passes
- No breaking changes to exported function signatures
</success_criteria>

<output>
After completion, create `.planning/phases/02-category-restructuring/02-02-SUMMARY.md`
</output>
